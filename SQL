 # 1
SELECT p.FullName, p.PhoneNumber AS Personal_Phone_Number, p.FaxNumber AS Personal_Fax_Number, 
COALESCE(c.PhoneNumber, s.PhoneNumber) AS Company_Phone_Number, COALESCE(c.FaxNumber, s.FaxNumber) AS Company_Fax_Number
FROM Application.People p
LEFT JOIN Sales.Customers c 
ON (p.PersonID = c.PrimaryContactPersonID) OR (p.PersonID = c.AlternateContactPersonID)
LEFT JOIN Purchasing.Suppliers s 
ON (p.PersonID = s.PrimaryContactPersonID) OR (p.PersonID = s.AlternateContactPersonID);

# 2
SELECT c.CustomerName
FROM Application.People p
INNER JOIN Sales.Customers c
ON (p.PersonID = c.PrimaryContactPersonID) AND (p.PhoneNumber = c.PhoneNumber);

# 3
SELECT c.CustomerName, ct.TransactionDate
FROM Sales.Customers c
INNER JOIN Sales.CustomerTransactions ct
ON c.CustomerID = ct.CustomerID
WHERE ct.TransactionDate < '2016-01-01' 
AND ct.CustomerID NOT IN 
(SELECT distinct ct.CustomerID
FROM Sales.CustomerTransactions ct
WHERE ct.TransactionDate > '2016-01-01');

# 4
SELECT s.StockItemName, SUM(s.QuantityPerOuter) as total_quantity
FROM Warehouse.StockItems s
INNER JOIN Purchasing.PurchaseOrderLines p
ON s.StockItemID = p.StockItemID
WHERE YEAR(p.LastReceiptDate)=2013
GROUP BY s.StockItemName;

# 5
SELECT DISTINCT s.StockItemName
FROM Warehouse.StockItems s
INNER JOIN Purchasing.PurchaseOrderLines p
ON s.StockItemID = p.StockItemID
WHERE LEN(p.Description) >= 10;

# 6
SELECT DISTINCT s.StockItemName
FROM Warehouse.StockItems s
INNER JOIN Application.People p
ON s.LastEditedBy = p.PersonID
INNER JOIN Application.StateProvinces sp
ON p.PersonID = sp.LastEditedBy
INNER JOIN Purchasing.PurchaseOrderLines po
ON s.StockItemID = po.StockItemID
WHERE YEAR(po.LastReceiptDate)=2014 AND
sp.StateProvinceName != 'Alabama' OR sp.StateProvinceName != 'Georgia';

# 7
SELECT AVG(DATEDIFF(day, o.OrderDate,i.ConfirmedDeliveryTime)), sp.StateProvinceName
FROM Sales.Invoices i
INNER JOIN Sales.Orders o
ON i.OrderID = o.OrderID
INNER JOIN Application.People p
ON o.LastEditedBy = p.PersonID
INNER JOIN Application.StateProvinces sp
ON p.PersonID = sp.LastEditedBy
GROUP BY sp.StateProvinceName;

# 8
SELECT AVG(DATEDIFF(day, o.OrderDate,i.ConfirmedDeliveryTime)), sp.StateProvinceName,  MONTH(o.OrderDate) AS Month
FROM Sales.Invoices i
INNER JOIN Sales.Orders o
ON i.OrderID = o.OrderID
INNER JOIN Application.People p
ON o.LastEditedBy = p.PersonID
INNER JOIN Application.StateProvinces sp
ON p.PersonID = sp.LastEditedBy
GROUP BY sp.StateProvinceName, MONTH(o.OrderDate);

# 9 
WITH Transaction_table AS (SELECT si.StockItemName,
sum(case when s.Quantity < 0 then s.Quantity else 0 end) OVER(PARTITION BY s.CustomerID) as Sold, 
sum(case when s.Quantity > 0 then s.Quantity else 0 end) OVER (PARTITION BY s.CustomerID) as Purchased
FROM Warehouse.StockItemTransactions s
INNER JOIN Warehouse.StockItems si
ON s.StockItemID = si.StockItemID
WHERE YEAR(s.TransactionOccurredWhen) = 2015) 
SELECT t.StockItemName 
FROM Transaction_table t
WHERE t.Sold < t.Purchased;

# 10
WITH Contact_Table AS (
SELECT c.CustomerID, c.CustomerName, c.PhoneNumber, p.FullName as Primary_Contact_Person
FROM Sales.Customers c
INNER JOIN Application.People p 
ON c.PrimaryContactPersonID = p.PersonID) 
SELECT ct.CustomerName, ct.PhoneNumber, ct.Primary_Contact_Person
FROM Warehouse.StockItemTransactions st
INNER JOIN Warehouse.StockItems s
ON st.StockItemID = s.StockItemID
INNER JOIN Contact_Table ct
ON ct.CustomerID = st.CustomerID 
WHERE YEAR(st.TransactionOccurredWhen) = 2016
AND s.StockItemName LIKE '%mug%'
AND st.Quantity <0 AND st.Quantity >-11

